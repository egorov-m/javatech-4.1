# javatech-4.1
ДЗ: Инфраструктура web-приложений.

## Инструкция по установки и настройки сервера.

Для демонстрации процесса установки и настройки будет использоваться [VirtualBox](https://www.virtualbox.org). Это программный пакет виртуализации, который поддерживает создание и управление виртуальными машинами, в которые можно установить вторую операционную систему.

### 0. Установка VirtualBox.
Вы можете загрузить последнюю версию VirtualBox с официального сайта: https://www.virtualbox.org/wiki/Downloads в зависимости от вашей операционной системы.

Инструкцию по установки можно найти по ссылке: https://www.virtualbox.org/manual/ch02.html.

### 1. Скачивание операционной системы сервера.
Windows является широко известной OS среди широких масс, но большинство разработчиков предпочитают Linux из-за стабильности, безопасности и гибкости настройки. Linux - это бесплатная и очень легкая операционная система с открытым исходным кодом.

Существует много различных Linux дистрибутивов, для примера будет использоваться Ubuntu, поскольку это один из самых популярных и известных дистрибутивов Linux, основан на Debian.

Загрузить Ubuntu Server можно по ссылке: https://ubuntu.com/download/server, рекомендуется использовать LTS версию — с долгосрочной поддержкой.

### 2. Создание новой виртуальной машины в VirtualBox.
1. Запустите VirtualBox.
2. Нажмите кнопку создать/new.
3. Укажите имя новой виртуальной машины; укажите директорию для машины; выберите тип "Linux", версия Ubuntu (64-bit). Нажмите далее/next.
4. Выдерите объём ОЗУ для виртуальной машины, не рекомендуется выходить за зелёную зону. Нажмите далее.
5. Выбор жёсткого диска: выдерите пункт "создать виртуальный жёсткий диск". Нажмите далее.
6. Выберите тип жёсткого диска: "VDI (VirtualBox Disk Image)". Подробнее можно прочитать [здесь](https://www.virtualbox.org/manual/ch05.html#vdidetails). Нажмите далее.
7. Выбор формата хранения: выберите динамический формат хранения. Подробнее можно прочитать [здесь](https://www.virtualbox.org/manual/ch05.html#vdidetails). Нажмите далее.
8. Выберите размер виртуального жёсткого диска. Нажмите создать/create.
9. Вернувшись в VirtualBox Manager, вы должны увидеть только что созданную виртуальную машину слева в списке.

### 3. Установка операционной системы на виртуальную машину.
1. Перейдите в настройки виртуальной машины. Раздел носители. Добавьте ранее скаченный ISO образ в качестве носителя.
2. Запустите виртуальную машину. Начнётся процесс установки Ubuntu.
3. Откроется [GNU GRUB](https://wikipedia.org/wiki/GNU_GRUB). У меня версия [2.06](https://www.gnu.org/software/grub/manual/grub/grub.html). Выберите "Try or Install Ubuntu Server".
4. Откроется экран приветствия. Выберите предпочитаемый язык.
5. Откроется экран обновления установщика. Можно выбрать: обновить или игнорировать обновления. Я выбираю обновить.
6. Откроется меню конфигурации клавиатуры. Вы можете выбрать свою раскладку или выбрать пункт автоматической идентификации.
7. Выбор типа установки: можно выбрать установку по умолчанию с уже подобранным набором пакетов или выбрать минимизированную версию.
8. Настройка сетевого соединения. Ubuntu попытается настроить стандартный сетевой интерфейс. Обычно можно принять значения по умолчанию и продолжить.
9. Настройка Proxy. Если ваша система требует прокси-сервер для подключения к сети, то вы можете указать данные в этом диалоговом окне.
10. Настройка зеркала Ubuntu. Если вы хотите использовать альтернативное зеркало, то вы можете его указать здесь. Я выбираю зеркало по умолчанию.
11. Конфигурация хранилища. Установщик может вам помочь разбить весь диск на разделы или вы это можете сделать вручную.
12. Сводная информация о настройки. Откроется экран, на котором будет отображено всё что вы ранее выбрали. Если вас всё устраивает жмите готово.
13. Настройка профиля. Заполните данные, как считаете нужным. Ваше имя, имя вашего сервера, имя пользователя, пароль.
14. Настройка SSH. Здесь у вас есть возможность установить [серверный пакет OpenSSH](https://ubuntu.com/server/docs/service-openssh). Также здесь есть возможность импорта SSH ключей.
15. Подборка серверных [Snap](https://snapcraft.io/docs/getting-started) пакетов популярных для выбранной системы. Выбирайте на своё усмотрение.
16. Установщик будет устанавливать Ubuntu выбранной версии. После завершения нажмите "Перезагрузить сейчас".

### 4. Настройка удалённого доступа по SSH.
После перезагрузки виртуальной машины с только что установленной операционной системой можно заметить, что некоторые установленные пакеты не обновлены. Нужно воспользоваться командами:
```sh
sudo apt update # обновляет индексы пакетов в системе Linux и списки пакетов (/etc/apt/sources.list)
sudo apt upgrade # обновляет пакеты программного обеспечения до последних версий
```
*sudo — от имени супер пользователя;
*apt — воспользоваться пакетным менеджером [Advanced Packaging Tool](https://wikipedia.org/wiki/Advanced_Packaging_Tool);

Далее, проверим, что SSH установлен (в случае, если вы выбирали опцию "Установить сервер OpenSSH" во время установки) введя команду:
```sh
ssh
```
Если выдаёт ошибку, вам нужно воспользоваться командой:
```sh
sudo apt-get install openssh-server
```

#### Настройка сети виртуальной машины.
Перед настройкой нужно выключить машину, введя команду:
```sh
poweroff
```
В VirtualBox Manager выберите только что созданную виртуальную машину и нажмите "Настроить". Перейдите на вкладку "Сеть". Выберите "Адаптер 1". Теперь нужно определиться какой способ подключения будем использовать. Я оставляю исходный интерфейс NAT, буду использовать для подключения по SSH [переадресацию портов](https://stackoverflow.com/a/10532299/1136887).
```sh
Прописываю параметры пробрасывания портов:
Name: SSH port forwarding, лучше использовать осмысленное название
Protocol: TCP
Host IP: 127.0.0.1
Host Port: 2222
Guest IP: 10.0.2.15, можно узнать командой "ip address"
Guest Port: 22
```

Про настройку сети виртуальной машины можно прочитать [здесь](https://www.virtualbox.org/manual/ch06.html).
Про удалённый доступ к виртуальной машине можно прочитать [здесь](https://www.virtualbox.org/manual/ch07.html).

#### Сеанс SSH.
В терминале вашей основной операционной системы запустите команду ssh в следующем формате:
```sh
ssh -p 2222 username@127.0.0.1
```
Далее введите пароль от гостевой OS, затем будет предложено инициировать соединение.

В случае, если команда выдаёт ошибку, введите команду:
```sh
# команда актуальна для Linux, в Windows, например, можно воспользоваться Git Bash'ем, там openssh-client предустановлен.
sudo apt install openssh-client
```

### 5. Запуск и остановка виртуальной машины в Headless Mode.
Убедитесь, что вам доступны через терминал команды VBoxManager и д.р, для этого нужно пропись путь до VirtualBox в переменной PATH.

Для запуска/остановки/приостановки вам нужно знать имя виртуальной машины. Чтобы увидеть список виртуальных машин введите команду:
```sh
VBoxManage list vms # отобразит все виртуальные машины, а также их уникальные идентификаторы
```
**Запуск:**
```sh
VBoxManage startvm "VM Name" --type headless
```
**Приостановка:**
```sh
VBoxManage controlvm "VM Name" pause --type headless
```
**Перезапуск приостановленной машины:**
```sh
VBoxManage controlvm "VM Name" resume --type headless
```
**Остановка:**
```sh
VBoxManage controlvm "VM Name" poweroff --type headless
```

### 6. Вход по SSH без ввода пароля.
Ключи SSH могут обеспечить безопасный способ входа на сервер без необходимости ввода пароля.

Для этого нужно сгенерировать пару ключей. Открытый и закрытый. Закрытый — хранится на вашем хостовом компьютере и его нужно тщательно охранять. Открытый ключ копируется на сервер к которому вы хотите подключиться.

#### Генерация ключей.
Для генерации ключей нужно воспользоваться командой:
```sh
ssh-keygen
```
Например, вот так:
```sh
ssh-keygen -o -b 4096 -t rsa
```
-o — хранение закрытого ключа в новом, более безопасном формате;
-b 4096 — установка длинны закрытого ключа 4096 бит, вместо 1024 по умолчанию;
-t rsa — создание [rsa ключей](https://wikipedia.org/wiki/RSA);

Далее, будет предложен указать: где сохранить ключи, какую парольную фразу использовать;

#### Копирование ключа на сервер
Вам нужно запустить сервер удобным для вас способом.
Для копирования ключа я воспользуюсь командой ssh-copy-id, в моём случае в формате:
```sh
ssh-copy-id -i ./.ssh/id_rsa.pub -p 2222 username@127.0.0.1
```
-i ./.ssh/id_rsa.pub — путь к созданному публичному SSH ключу;
-p 2222 username@127.0.0.1 данные моего Ubuntu сервера (используется проброс портов);

После того, как ключ будет скопирован вы сможете подключаться к серверу без пароля, в моём случае, используя команду ssh в формате:
```sh
ssh -p 2222 username@127.0.0.1
```
